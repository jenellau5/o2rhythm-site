<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scan &amp; Reset — O₂ Rhythm</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <style>
    :root {
      --ring: #ffffff;
    }

    .prompt {
      margin-top: 14px;
      font-size: 1.65rem;
      font-weight: 950;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-align: center;
    }

    .promptSub {
      margin-top: 10px;
      font-size: 1.15rem;
      line-height: 1.35;
      color: rgba(255, 255, 255, .84);
      text-align: center;
    }
  </style>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5NKZ7XYYWF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-5NKZ7XYYWF');
  </script>

</head>

<body>
  <main class="wrap">
    <section class="card protocol" data-agency="mytrex" data-environment="desk" data-protocol-id="scan_reset">

      <div class="brand">O₂ RHYTHM</div>
      <h1>SCAN &amp; RESET</h1>
      <p class="sub">45 sec • Simple commands</p>

      <div class="ringbox">
        <svg class="progressRing" viewBox="0 0 220 220" aria-hidden="true">
          <circle class="progress-bg" cx="110" cy="110" r="100"></circle>
          <circle class="progress" cx="110" cy="110" r="100"></circle>
        </svg>

        <div id="pacer" class="pacer">
          <div class="center">
            <button id="startBtn" class="start" type="button">START</button>
            <div id="timer" class="timer">0:45</div>

            <div id="phaseLabel" class="phaseLabel">READY</div>
            <div id="count" class="count"></div>
            <div id="dots" class="phaseDots"></div>
          </div>
        </div>
      </div>

      <div class="prompt" id="prompt">READY</div>
      <div class="promptSub" id="promptSub">Press START.</div>

      <div class="toggleRow">
        <button id="soundToggle" class="toggle" type="button">SOUND: OFF</button>
      </div>

      <div class="navrow">
        <a class="pill" href="desk.html">Back</a>
        <a class="pill" href="library.html">Library</a>
      </div>

      <div class="feedback">
        <a class="feedback-link" href="feedback.html">Pilot feedback (30 seconds)</a>
      </div>
    </section>
  </main>

  <script>
    // ---------- Elements ----------
    const page = document.querySelector(".protocol");
    const startBtn = document.getElementById("startBtn");
    const timerEl = document.getElementById("timer");
    const phaseLabelEl = document.getElementById("phaseLabel");
    const promptEl = document.getElementById("prompt");
    const promptSubEl = document.getElementById("promptSub");
    const progressCircle = document.querySelector(".progress");
    const soundToggleBtn = document.getElementById("soundToggle");

    // ---------- Config ----------
    const total = 45;
    let timeLeft = total;
    let running = false;
    let interval = null;

    // ---------- GA4 identity (optional) ----------
    const agency = page?.dataset.agency || "unknown";
    const environment = page?.dataset.environment || "unknown";
    const protocolId = page?.dataset.protocolId || "unknown";

    function ga(eventName, params = {}) {
      if (typeof window.gtag !== "function") return;
      window.gtag("event", eventName, {
        agency,
        environment,
        protocol: protocolId,
        page_path: location.pathname,
        ...params
      });
    }

    // ---------- Ring math ----------
    const r = 100;
    const circumference = 2 * Math.PI * r;
    progressCircle.style.strokeDasharray = String(circumference);
    progressCircle.style.strokeDashoffset = String(circumference);

    function fmt(s) {
      const m = Math.floor(s / 60);
      const ss = String(s % 60).padStart(2, "0");
      return `${m}:${ss}`;
    }

    function setOverallProgress(secondsRemaining) {
      const elapsed = total - secondsRemaining;
      const ratio = Math.min(1, Math.max(0, elapsed / total));
      const offset = circumference - ratio * circumference;
      progressCircle.style.strokeDashoffset = String(offset);
    }

    // ---------- SOUND ON/OFF (session remembered) ----------
    const SS_SOUND = "o2_sound_enabled";
    let soundEnabled = sessionStorage.getItem(SS_SOUND) === "1";
    let audioCtx = null;

    function ensureAudioContext() {
      if (audioCtx) return;
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if (!Ctx) return;
      audioCtx = new Ctx();
    }

    function setSoundUI() {
      soundToggleBtn.textContent = soundEnabled ? "SOUND: ON" : "SOUND: OFF";
      soundToggleBtn.setAttribute("aria-pressed", soundEnabled ? "true" : "false");
    }

    function beep(freq = 440, durationSec = 0.10) {
      if (!soundEnabled) return;
      ensureAudioContext();
      if (!audioCtx) return;

      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = "sine";
      osc.frequency.value = freq;

      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.04, now + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + durationSec);

      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start(now);
      osc.stop(now + durationSec);
    }

    soundToggleBtn.addEventListener("click", () => {
      soundEnabled = !soundEnabled;
      sessionStorage.setItem(SS_SOUND, soundEnabled ? "1" : "0");
      if (soundEnabled) ensureAudioContext();
      setSoundUI();
      ga("protocol_toggle", { toggle: "sound", enabled: soundEnabled ? 1 : 0 });
    });

    // ---------- Phases (durations in seconds) ----------
    const phases = [
      { label: "SEE", cmd: "NAME 3 THINGS YOU SEE", sub: "Take your time. 1… 2… 3…", tone: 520, dur: 15 },
      { label: "HEAR", cmd: "NAME 2 THINGS YOU HEAR", sub: "1… 2…", tone: 440, dur: 10 },
      { label: "FEEL", cmd: "NAME 1 THING YOU FEEL", sub: "hands • feet • chair", tone: 330, dur: 8 },
      { label: "JAW", cmd: "UNCLENCH YOUR JAW", sub: "tongue down. lips soft.", tone: 520, dur: 5 },
      { label: "SHOULDERS", cmd: "DROP SHOULDERS", sub: "down and back.", tone: 440, dur: 5 },
      { label: "READY", cmd: "BACK TO TASK", sub: "continue.", tone: 330, dur: 2 }
    ];

    let currentIdx = -1;

    function applyPhaseByElapsed(elapsedSeconds) {
      let acc = 0;
      for (let i = 0; i < phases.length; i++) {
        acc += phases[i].dur; // end time of this phase
        if (elapsedSeconds < acc) {
          if (i !== currentIdx) {
            currentIdx = i;
            const p = phases[i];
            phaseLabelEl.textContent = p.label;
            promptEl.textContent = p.cmd;
            promptSubEl.textContent = p.sub;
            beep(p.tone);
          }
          return;
        }
      }
    }

    // ---------- UI ----------
    function resetUI() {
      running = false;
      timeLeft = total;
      timerEl.textContent = fmt(total);
      setOverallProgress(total);

      phaseLabelEl.textContent = "READY";
      promptEl.textContent = "READY";
      promptSubEl.textContent = "Press START.";

      startBtn.disabled = false;
      startBtn.textContent = "START";
      currentIdx = -1;
    }

    function endSession() {
      ga("protocol_complete", { total_seconds: total });

      clearInterval(interval);
      interval = null;
      running = false;

      startBtn.textContent = "DONE";
      phaseLabelEl.textContent = "DONE";
      promptEl.textContent = "DONE";
      promptSubEl.textContent = "Continue.";

      setTimeout(resetUI, 900);
    }

    // If they background the page mid-run, track it (optional)
    window.addEventListener("visibilitychange", () => {
      if (!running) return;
      if (document.visibilityState === "hidden") {
        ga("protocol_abandon", { seconds_remaining: timeLeft });
      }
    });

    // ---------- Start ----------
    function start() {
      if (running) return;

      running = true;
      startBtn.disabled = true;
      startBtn.textContent = "RUNNING";
      ga("protocol_start", { total_seconds: total });

      timeLeft = total;
      timerEl.textContent = fmt(timeLeft);
      setOverallProgress(timeLeft);

      // Phase at time 0
      applyPhaseByElapsed(0);

      interval = setInterval(() => {
        timeLeft -= 1;

        timerEl.textContent = fmt(Math.max(0, timeLeft));
        setOverallProgress(Math.max(0, timeLeft));

        const elapsed = total - timeLeft;
        applyPhaseByElapsed(elapsed);

        if (timeLeft <= 0) endSession();
      }, 1000);
    }

    startBtn.addEventListener("click", start);

    // ---------- Init ----------
    setSoundUI();
    resetUI();
  </script>
</body>

</html>